runs = [('ly4w0wfh', 'base_opt_2023-06-21_23-59-59_96PanNRwmh5XcLxu3ogFwH'),
 ('n1euwvkk', 'base_2023-06-22_00-00-02_nao4K4CEnJGFRttixuxAgJ'),
 ('ns8404s7', 'base_2023-06-22_00-00-02_gfM6K3udw3UrQqkekX4RaV'),
 ('vvl62e31', 'base_opt_2023-06-21_23-59-59_N6bG5UfU5JLC4K87pVV6dJ'),
 ('8gje45s1', 'base_2023-06-22_00-00-02_VABpWGFrBfsYPB3uUVKMLy'),
 ('9b2lk4ju', 'base_2023-06-22_00-00-04_VK7wzY2ZWF52S9koYRFGdV'),
 ('cuayhsxk', 'base_opt_2023-06-22_00-00-03_ecLYJUG95t4Kkv9JT58Wg8'),
 ('1ecmeuwy', 'base_opt_2023-06-22_00-00-04_L2mEFTCcodiKAyW2bsGYfZ'),
 ('2zm9yrbl', 'base_opt_2023-06-22_00-00-02_UJDG2aqG7B29mpCi9VZAxA'),
 ('wwja31az', 'base_2023-06-22_00-00-05_QCN4UAZbYuNzLqX5nYKdmJ'),
 ('ogv8xsor', 'base_2023-06-22_00-00-07_HzhmvtrWvH4HP4cEp7jwNh'),
 ('p4i4e69w', 'base_2023-06-22_00-00-07_5LoZ2xPLgHPinhxdo9chJs'),
 ('rimybg7b', 'base_opt_2023-06-22_00-00-03_22PNVnXjgoBF6J3GuZqysb'),
 ('96gfw79e', 'base_opt_2023-06-22_00-00-05_jLojqBhPzshDuPq3xbqYW7'),
 ('dfaz2nyr', 'base_opt_2023-06-22_00-00-06_oEtCHGiCSBH922b5pd6efS'),
 ('5eljxe7u', 'base_2023-06-22_00-00-08_3GscGWrD6yEY4mCTy2Pa92'),
 ('ajcokus2', 'base_noheur_2023-06-22_00-00-25_C3syTPJCNVjCwNhcaM4VRz'),
 ('c7kbigir', 'base_noheur_2023-06-22_00-00-25_D7nszFfwktHkEr9XxVuFUt'),
 ('dsq7bk5h', 'base_noheur_2023-06-22_00-00-25_V96CA86QQWS7gsefTxGUe5'),
 ('pfcarkd9', 'base_noheur_2023-06-22_00-00-25_oSzm3DBeACZ2HaSJw5Gz3N'),
 ('qe3zeyz0', 'base_noheur_2023-06-22_00-00-25_RmZ5WbPkVjQkk55RWjpaxs'),
 ('tpyuz56h', 'base_noheur_2023-06-22_00-00-25_QsrtTy8CwRG2F8MouzvB8j'),
 ('v80q15os', 'base_noheur_2023-06-22_00-00-25_XL49aw3YqqCnNebbTyWcTh'),
 ('ro3qobsg', 'base_noheur_2023-06-22_00-00-25_m77RZ4MHwRQe8HbqqJzWeR'),
 ('q9h58bci', 'base_noacc_2023-06-22_00-00-28_FJhu4Fyy8EiqVZNJ4EkXDA'),
 ('46tz1qb6', 'energy_complex_2023-06-22_00-00-31_kvsN2JYuB9L4Ry6chhkFR9'),
 ('4h4r67h0', 'energy_complex_2023-06-22_00-00-30_UJDYRdV7sn5mbGcQpKkdi7'),
 ('5xjje1gw', 'energy_complex_2023-06-22_00-00-31_CJMvifqQD3JjnDYRswPrQL'),
 ('93fm2ixh', 'base_noacc_2023-06-22_00-00-28_YQggLRENtDGAnTiJtMBFSK'),
 ('c01j1b3q', 'base_noacc_2023-06-22_00-00-28_AFBLDBhiqP9Do4DszLBx9Z'),
 ('j62v3ygv', 'base_noacc_2023-06-22_00-00-29_ETQ4UHnV5xCkzUVDjTLBEo'),
 ('p08fv12e', 'base_noacc_2023-06-22_00-00-27_eZhaWdFAsAEZTtixnZ8iDN'),
 ('w8sy0rtk', 'energy_complex_2023-06-22_00-00-30_Eh8b2Tzg2a4BaLmcBH2C9S'),
 ('xkcqbwtq', 'energy_complex_2023-06-22_00-00-30_VsZzyYmcEkiCZ6v6bMhzpE'),
 ('1mhx1mxe', 'base_noacc_2023-06-22_00-00-28_LL2oUBst4D5yEpdYd7DcEc'),
 ('zmcv6jkw', 'energy_complex_2023-06-22_00-00-30_fwqDu5SFD9anMwrEAz5fMf'),
 ('1oezwdgi', 'base_noacc_2023-06-22_00-00-28_4FaNvaZhWKuqjtxRFNCmCy'),
 ('qmzmbg6f', 'energy_complex_2023-06-22_00-00-30_nbuVWAukq7X5cBeq4xtSbg'),
 ('kwdzo7j0', 'energy_complex_2023-06-22_00-00-30_5d4PNWRn9J9oucQ7t8PqNv'),
 ('htikqp8g', 'base_noacc_2023-06-22_00-00-29_BZWs49JvyJtpPsHeNnWvuF'),
 ('092409uy', 'energy_noacc_2023-06-22_00-04-57_5mQJTG78MJfeJCchbENCN3'),
 ('1bxg4w64', 'energy_noacc_2023-06-22_00-04-57_Ttw9E2DML6fa9fSkELDLKX'),
 ('2b3y01at', 'energy_nopot_2023-06-22_00-04-56_QbErYCRsPUko7NVNy84e5D'),
 ('3cylx2tl', 'energy_nopot_2023-06-22_00-04-57_nSie6LDSsWsmbRhwh6G6Ed'),
 ('5whn7lvj', 'energy_nopot_2023-06-22_00-04-59_HAi29ssTgtbYrYzFPNLBQH'),
 ('6c9hrrt7', 'energy_noacc_2023-06-22_00-04-57_7UVQ6bQBWFsi4gnAVUP77R'),
 ('9c5vsbtp', 'energy_nopot_2023-06-22_00-04-57_QL8BAa2DucXXyyw2D5H95h'),
 ('ffz0me9k', 'energy_nopot_2023-06-22_00-05-00_WfpsK7pxsA3yrs5rhwjy3y'),
 ('hfxqlibp', 'energy_nopot_2023-06-22_00-04-56_Mq6azHaW4xp63KEmaoYn5j'),
 ('hhf1nl3x', 'energy_noacc_2023-06-22_00-04-56_aVGhC6sjNjUFPzUT6cYpPH'),
 ('i5vckyxa', 'energy_nopot_2023-06-22_00-04-59_MRjKofrTUHcVeEJgP3zzpS'),
 ('inwwwfm7', 'kwiat_2023-06-22_00-04-58_DcbfxzoerfvY7siKQutB3y'),
 ('nwaps35v', 'kwiat_2023-06-22_00-04-58_jA8a3pikWzMhdAQGVXk79K'),
 ('oy69u32m', 'energy_nopot_2023-06-22_00-04-59_jfehXNNBHoAcfFrHAvUMvB'),
 ('p1k8yka9', 'energy_nopot_2023-06-22_00-04-59_JJR8Tup3dkAQ5KYdLToVEu'),
 ('q5hoiiz0', 'kwiat_2023-06-22_00-04-58_igwCnxEmzyS67pzQSgHsdS'),
 ('qif048hw', 'kwiat_2023-06-22_00-04-58_XUMnaXQmDd3gjMthJGVrUH'),
 ('s0ado3kz', 'energy_nopot_2023-06-22_00-04-56_8hVo46hQhWZy74xK8p3mpg'),
 ('swlavqn6', 'energy_nopot_2023-06-22_00-04-56_gEHr3AhcJAMcBneTLfUHbW'),
 ('xjmh4xja', 'kwiat_2023-06-22_00-04-58_c3uCGfkn9HACtcc4p5s9hh'),
 ('xo54jolj', 'energy_nopot_2023-06-22_00-04-56_3GKNVmZRWRw4fXxrEwUYLZ'),
 ('y6b1a28h', 'kwiat_2023-06-22_00-04-58_Xpnu8V5CFP9ZELbrPMTKSG'),
 ('yb8ae1m3', 'energy_noacc_2023-06-22_00-04-57_BRB7kgPQuFi4QqRebnhUE6'),
 ('zv3wb3e1', 'energy_noacc_2023-06-22_00-04-57_dMhoShcDZTAFKYtGiaBjkk'),
 ('7rxh05uh', 'energy_nopot_2023-06-22_00-04-59_hjV5cKnKPs8eCr7q7hhs6J'),
 ('f2rpzgyl', 'energy_nopot_2023-06-22_00-05-00_gVYhoLNTSntzvzvwtj5M55'),
 ('qnfyn86t', 'energy_nopot_2023-06-22_00-04-56_oBLc3ABcgFnaDr2PMG9k5p'),
 ('69uu6w8g', 'energy_nopot_2023-06-22_00-04-59_bPtV3po4XuQco8GsC2GcC5'),
 ('s950lrwm', 'kwiat_2023-06-22_00-04-58_2by9kChKQHt89ikJXqgQ9h'),
 ('vyhnaotr', 'kwiat_2023-06-22_00-04-58_NHGXFt6PrBBViX2KyuTDEp'),
 ('7o3mwm36', 'energy_noacc_2023-06-22_00-04-57_a35Prw9RgemTtCAWngZyFr'),
 ('7o3siq6f', 'kwiat_2023-06-22_00-05-01_6hgJMYbUZZ5stHnpEhZuG4'),
 ('blnw99al', 'kwiat_2023-06-22_00-05-00_4AJutpQPMfahC8BWiYqMkS'),
 ('g012oezj', 'energy_noacc_2023-06-22_00-04-57_evnyL4GLNDuD8HX244uzx5'),
 ('omezrpt2', 'kwiat_2023-06-22_00-05-01_L5Tsb3AN8AJd86eKyHJkkx'),
 ('oy90n656', 'kwiat_2023-06-22_00-05-01_dPWojbCddCoua93c8o6Khh'),
 ('s0v4nzrj', 'kwiat_2023-06-22_00-05-01_8kcK2HgWrGDetzWcuCNmG3'),
 ('v6go85e7', 'kwiat_2023-06-22_00-05-01_aRbPrmcKaCDDqfeSetoqDW'),
 ('9bsajipb', 'kwiat_2023-06-22_00-05-00_RMjBZoP8sysC7JKcV4qghC'),
 ('hihed27s', 'kwiat_2023-06-22_00-05-01_FwsmFrZNGYrGcC9TZzKFE7')]


import os
import sys
import subprocess

from typarse import BaseParser
import wandb


class Parser(BaseParser):
    env_path: str
    skip: int = 0
    force: bool = False
    only_finished: bool = False

    _help = {
        "env_path": "Path to the Unity environment binary",
        "skip": "Number of runs to skip",
        "force": "Whether to force the recording even if the video already exists",
        "only_finished": "Whether to only record videos for finished runs",
    }

    _abbrev = {
        "env_path": "e",
        "skip": "s",
        "force": "f",
        "only_finished": "o",
    }


def has_video(run: wandb.apis.public.Run):
    return any(key.startswith('video') for key in run.summary.keys())


# Sketch of the code to be generated
#  Iterate over all runs in the project
#   For each run, check if any key in `run.summary` starts with `video`
#    If it does, ignore the run unless `force` is set to True
#    If it doesn't, pull the config and the model, and use it to record a new video


if __name__ == "__main__":
    args = Parser()

    api = wandb.Api()

    num_runs = len(runs)

    for i, (run_id, save_path) in enumerate(runs):
        print(f"Processing run {i + 1}/{num_runs}")
        run_path = f"redtachyon/jz-crowd40-final/{run_id}"
        run = api.run(run_path)
        if not args.force and has_video(run):
            print(f"Skipping {run.name}")
            continue

        if args.only_finished and run.state != 'finished':
            print(f"Skipping {run.name} because it is not finished")
            continue

        # Run `do_record_from_wandb.py` as a separate process

        process = subprocess.Popen(
            [sys.executable, "fix_do_record.py", "--run_path", run_path, "--env_path", args.env_path, "--save_path", save_path],
            stdout=subprocess.PIPE, stderr=subprocess.PIPE
        )

        for line in iter(process.stdout.readline, b''):
            print(line.decode().strip())

        process.stdout.close()
        process.wait()

        stderr = process.stderr.read().decode()
        if stderr:
            print("Error: ", stderr)
        process.stderr.close()
